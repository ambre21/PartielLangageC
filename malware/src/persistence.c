#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <dlfcn.h>
#include <string.h>
#include <stdarg.h>
#include <stdlib.h>

// Définir le fichier à bloquer (corrigé)
#define BLOCKED_FILE "/home/debian/Bureau/test.txt"

// Déclaration de la fonction d'origine
static int (*original_open)(const char *pathname, int flags, ...) = NULL;

// Fonction utilitaire pour résoudre le chemin absolu
char* resolve_path(const char* pathname) {
    char* abs_path = realpath(pathname, NULL);
    if (abs_path == NULL) {
        fprintf(stderr, "Erreur: impossible de résoudre le chemin absolu de %s\n", pathname);
        return NULL;
    }
    return abs_path;
}

// Implémentation de notre hook pour open()
int open(const char *pathname, int flags, ...) {
    // Initialiser la fonction originale si nécessaire
    if (!original_open) {
        original_open = dlsym(RTLD_NEXT, "open");
        if (!original_open) {
            fprintf(stderr, "Erreur: impossible de récupérer open\n");
            return -1;
        }
    }

    // Résoudre le chemin absolu du fichier demandé
    char *abs_path = resolve_path(pathname);
    if (abs_path == NULL) {
        return -1;  // Retourne une erreur si la résolution du chemin échoue
    }

    // Afficher un message de debug
    printf("Tentative d'ouverture de : %s\n", abs_path);

    // Vérifier si le fichier est celui que l'on veut bloquer
    if (abs_path && strcmp(abs_path, BLOCKED_FILE) == 0) {
        printf("L'accès à %s est bloqué !\n", abs_path);
        free(abs_path);  // Libérer la mémoire allouée pour le chemin absolu
        return -1;  // Bloque l'accès
    }

    free(abs_path);  // Libérer la mémoire allouée pour le chemin absolu

    // Vérifier si un troisième argument est nécessaire
    va_list args;
    va_start(args, flags);
    int result;

    if (flags & O_CREAT) {
        mode_t mode = va_arg(args, mode_t);
        result = original_open(pathname, flags, mode);
    } else {
        result = original_open(pathname, flags);
    }

    va_end(args);
    return result;
}
